<?xml version="1.0"?>
<!--
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <!-- server & api -->
    <preference for="Magento\SearchStorefrontApi\Api\SearchInterface" type="Magento\SearchStorefrontApi\Api\InMemorySearch"/>
    <preference for="Magento\SearchStorefrontApi\Api\SearchServerInterface" type="Magento\SearchStorefront\Model\SearchService"/>

    <!-- Logger -->
    <virtualType name="SearchStorefrontLogger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="error" xsi:type="object">\Magento\SearchStorefront\Model\Logging\Error</item>
                <item name="debug" xsi:type="object">Magento\SearchStorefront\Model\Logging\Debug</item>
            </argument>
        </arguments>
    </virtualType>
    <type name="Magento\SearchStorefrontSearch\Model\EngineResolver">
        <arguments>
            <argument name="logger" xsi:type="object">SearchStorefrontLogger</argument>
        </arguments>
    </type>

    <!-- Connection config for elasticsearch -->
    <preference for="Magento\SearchStorefrontElasticsearch\Model\ConnectionConfigInterface" type="Magento\SearchStorefront\Model\Search\Client\Config" />

    <!-- Set path to active search engine -->
    <type name="Magento\SearchStorefrontSearch\Model\EngineResolver">
        <arguments>
            <argument name="path" xsi:type="string">search/engine</argument>
            <argument name="scopeType" xsi:type="string">default</argument>
        </arguments>
    </type>

    <preference for="Magento\Framework\Search\Request\Aggregation\StatusInterface" type="Magento\SearchStorefront\Model\Aggregation\Status" />

    <!-- Scope -->
    <preference for="Magento\Framework\App\ScopeResolverInterface" type="Magento\SearchStorefrontStore\Model\Scope\ScopeResolver" />

    <type name="Magento\Framework\EntityManager\MetadataPool">
        <arguments>
            <argument name="metadata" xsi:type="array">
                <item name="catalog_category" xsi:type="array">
                    <item name="entityTableName" xsi:type="string">catalog_category_entity</item>
                    <item name="eavEntityType" xsi:type="string">catalog_category</item>
                    <item name="identifierField" xsi:type="string">entity_id</item>
                    <item name="entityContext" xsi:type="array">
                        <item name="store" xsi:type="string">Magento\SearchStorefrontStore\Model\StoreScopeProvider</item>
                    </item>
                </item>
            </argument>
        </arguments>
    </type>

    <preference for="Magento\Framework\Search\Adapter\OptionsInterface" type="Magento\SearchStorefront\Model\Adapter\Options"/>

    <preference for="Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\LayerBuilderInterface"
            type="Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\LayerBuilder"/>

    <type name="Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\LayerBuilder">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="price_bucket" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\Builder\Price</item>
                <item name="category_bucket" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\Builder\Category</item>
                <item name="attribute_bucket" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\LayeredNavigation\Builder\Attribute</item>
            </argument>
        </arguments>
    </type>

    <!-- configure pool of search criteria appliers for filters, sort orders, search phrase etc. -->
    <type name="Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\ApplierPool">
        <arguments>
            <argument name="searchCriteriaAppliers" xsi:type="array">
                <item name="phrase" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\PhraseApplier</item>
                <item name="filters" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\FilterApplier</item>
                <item name="request_name" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\RequestTypeApplier</item>
                <item name="sort" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\SortApplier</item>
                <item name="page_size" xsi:type="object">Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder\PageApplier</item>
            </argument>
        </arguments>
    </type>

    <preference for="Magento\SearchStorefront\DataProvider\Product\SearchCriteria\SearchCriteriaBuilderInterface"
            type="Magento\SearchStorefront\DataProvider\Product\SearchCriteria\Builder"/>

    <preference for="Magento\Framework\Search\Dynamic\DataProviderInterface" type="Magento\SearchStorefront\SearchAdapter\Dynamic\DataProvider" />

    <type name="Magento\SearchStorefrontElasticsearch\SearchAdapter\Aggregation\Builder">
        <arguments>
            <argument name="dataProviderContainer" xsi:type="array">
                <item name="catalogsearch_fulltext" xsi:type="object">Magento\SearchStorefront\SearchAdapter\Dynamic\DataProvider</item>
            </argument>
        </arguments>
    </type>

    <type name="Magento\SearchStorefront\SearchAdapter\Dynamic\DataProvider">
        <arguments>
            <argument name="indexerId" xsi:type="string">catalogsearch_fulltext</argument>
        </arguments>
    </type>

    <!-- scope resolvers replacements that are reading via direct sql -->
    <type name="Magento\Framework\Search\Request\Config\FilesystemReader">
        <plugin name="productAttributesDynamicFields"  type="Magento\SearchStorefront\Plugin\Search\Request\ConfigReader" />
    </type>
    <type name="Magento\SearchStorefront\Model\Search\RequestGenerator\GeneratorResolver">
        <arguments>
            <argument name="defaultGenerator" xsi:type="object">\Magento\SearchStorefront\Model\Search\RequestGenerator\General</argument>
            <argument name="generators" xsi:type="array">
                <item name="decimal" xsi:type="object">Magento\SearchStorefront\Model\Search\RequestGenerator\Decimal</item>
            </argument>
        </arguments>
    </type>
</config>
